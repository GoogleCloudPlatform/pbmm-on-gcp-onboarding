stages:
- stage: bootstrap
  displayName: 'bootstrap terraform'

  jobs:
  - job: Initialisation
    displayName: 'Initialisation environnement'
    steps:
    - template: ../templates/securefile-template.yaml
    - script: |
        export SUPER_ADMIN_EMAIL=$SUPER_ADMIN_EMAIL
        export REGION=$REGION
        export ORG_ID=$ORG_ID
        export ROOT_FOLDER_ID=$ROOT_FOLDER_ID
        export BILLING_ID=$BILLING_ID
        echo $SUPER_ADMIN_EMAIL
        echo $REGION
        echo $ORG_ID
        echo $ROOT_FOLDER_ID
        echo $BILLING_ID
        gcloud auth activate-service-account sa-gcp-partners-test@sa-test-gcp.iam.gserviceaccount.com --key-file=$(googleCredentials.secureFilePath)
      displayName: 'Initialisiation environnement'
  - job: DeployScript
    displayName: 'DeployScript'
    dependsOn: Initialisation
    timeoutInMinutes: 120
    steps:
    - script: |
        chmod +x automation-scripts/0-bootstrap/0-bootstrap.sh
        chmod +x automation-scripts/whole.sh
        chmod +x ./0-bootstrap/prep.sh
      displayName: 'Set execute permissions on script'
    - template: ../templates/securefile-template.yaml
    - script: |
        gcloud auth activate-service-account sa-gcp-partners-test@sa-test-gcp.iam.gserviceaccount.com --key-file=$(googleCredentials.secureFilePath)
        gcloud config set project sa-test-gcp
        gcloud auth list
        export GOOGLE_APPLICATION_CREDENTIALS=$(googleCredentials.secureFilePath)
        echo xyz
        wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
        unzip terraform_1.6.0_linux_amd64.zip
        echo $GOOGLE_APPLICATION_CREDENTIALS
        echo GOOGLE_IMPERSONATE_SERVICE_ACCOUNT=$GOOGLE_IMPERSONATE_SERVICE_ACCOUNT
        chmod +x ./build/tf-wrapper.sh
        python3 ./fix_tfvars_symlinks.py .
        ./automation-scripts/whole.sh $GOOGLE_APPLICATION_CREDENTIALS
      displayName: 'Run bootstrap.sh'
  #- job: Deployment
  #  displayName: 'Deployment'
  #  dependsOn: SetupScript
  #  steps:
  #  - script: |
  #      terraform init